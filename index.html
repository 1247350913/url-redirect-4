<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">

<!-- PWA niceties (lets users install and hide browser chrome) -->
<meta name="theme-color" content="#000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="manifest" href="/manifest.webmanifest">

<style>
  :root { color-scheme: dark; }
  html, body { height:100%; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; background:#0a0a0a; }

  header { padding:12px 16px; background:#0f0f0f; color:#aaa;
           box-shadow:0 1px 0 rgba(255,255,255,.06); display:flex; gap:12px; align-items:center; }
  header button { padding:8px 12px; border-radius:8px; border:1px solid #333; background:#111; color:#eee; cursor:pointer; }
  header button:hover { background:#161616; }

  #grid { padding:16px; display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:12px; }
  .card { background:#111; border:1px solid #222; border-radius:12px; overflow:hidden; box-shadow:0 1px 2px rgba(0,0,0,.4); cursor:pointer; }
  .card img { width:100%; height:160px; object-fit:cover; display:block; background:#151515; }
  .name { padding:8px 10px; font-size:12px; color:#bbb; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  /* Lightbox */
  #lightbox { position:fixed; inset:0; background:#000; /* solid black */
              display:none; align-items:center; justify-content:center; z-index:9999; }
  #lightbox.open { display:flex; }
  #lightbox img { max-width:100vw; max-height:100vh; }

  .nav { position:fixed; top:50%; transform:translateY(-50%); font-size:28px; color:#fff;
         background:rgba(255,255,255,.08); border:0; width:48px; height:48px; border-radius:999px; cursor:pointer; }
  .nav:hover { background:rgba(255,255,255,.14); }
  #prev { left:24px; } #next { right:24px; }

  #close { position:fixed; top:20px; right:20px; font-size:22px; color:#fff;
           background:rgba(255,255,255,.08); border:0; width:44px; height:44px; border-radius:999px; cursor:pointer; }

  /* Hide scroll when lightbox open */
  body.no-scroll { overflow:hidden; }
</style>

<header>
  <span id="hint" style="color:#9a9a9a;font-size:13px;">Loading…</span>
  <span style="flex:1"></span>
  <button id="signin" style="display:none;">Sign in</button>
</header>

<div id="grid"></div>

<div id="lightbox" aria-modal="true" role="dialog">
  <button id="close" title="Close">✕</button>
  <button class="nav" id="prev" title="Previous">‹</button>
  <img id="big" alt="">
  <button class="nav" id="next" title="Next">›</button>
</div>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
  // ====== Config ======
  const CLIENT_ID = '952269671741-94el0o54hqe08rl9floeph3gbonvp12u.apps.googleusercontent.com';
  const SCOPES    = 'openid email profile https://www.googleapis.com/auth/drive.readonly';
  const FOLDER_ID = '1VmixAtpfvh-VaHEo7VFsIZgnLK87RPB1';

  // ====== State / DOM ======
  let tokenClient, accessToken = null, files = [], idx = 0;
  const hintEl    = document.getElementById('hint');
  const signinBtn = document.getElementById('signin');
  const grid      = document.getElementById('grid');
  const box       = document.getElementById('lightbox');
  const big       = document.getElementById('big');

  // iOS trick: nudge to hide top/bottom bars a bit after load
  window.addEventListener('load', () => setTimeout(() => window.scrollTo(0, 1), 300));

  // ====== Auth bootstrap ======
  window.addEventListener('load', () => {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: (resp) => {
        if (resp && resp.access_token) {
          accessToken = resp.access_token;
          onAuthed();
        } else {
          showSignIn();
        }
      }
    });

    trySilent();
    signinBtn.addEventListener('click', () => tokenClient.requestAccessToken({ prompt: 'consent' }));
  });

  function trySilent() {
    tokenClient.callback = (resp) => {
      if (resp && resp.access_token) {
        accessToken = resp.access_token;
        onAuthed();
      } else {
        showSignIn();
      }
    };
    tokenClient.requestAccessToken({ prompt: '' });
    setTimeout(() => { if (!accessToken) showSignIn(); }, 1200);
  }

  function showSignIn() {
    hintEl.textContent = 'Sign in to view shared images';
    signinBtn.style.display = 'inline-block';
  }

  async function onAuthed() {
    signinBtn.style.display = 'none';
    try { await loadGallery(); } catch (err) { fail(err); }
  }

  // ====== Drive listing & render ======
  async function loadGallery() {
    hintEl.textContent = 'Loading images…';

    const q = `'${FOLDER_ID}' in parents and mimeType contains 'image/' and trashed = false`;
    const fields = 'files(id,name,mimeType),nextPageToken';
    const url = `https://www.googleapis.com/drive/v3/files` +
      `?q=${encodeURIComponent(q)}` +
      `&fields=${encodeURIComponent(fields)}` +
      `&orderBy=name&pageSize=1000` +
      `&supportsAllDrives=true&includeItemsFromAllDrives=true`;

    const res = await fetch(url, { headers: { Authorization: `Bearer ${accessToken}` } });
    if (!res.ok) throw new Error('Drive list failed: ' + (await res.text()));
    const data = await res.json();

    if (!data.files || !data.files.length) {
      hintEl.textContent = 'No images (or you don’t have access).';
      return;
    }

    hintEl.textContent = '';
    files = data.files.map(f => ({ id: f.id, name: f.name, blobUrl: null }));

    for (let i = 0; i < files.length; i++) {
      const card = document.createElement('div');
      card.className = 'card';

      const img = document.createElement('img');
      img.alt = files[i].name;
      img.src = ''; // will fill after fetch

      const name = document.createElement('div');
      name.className = 'name';
      name.textContent = files[i].name;

      card.appendChild(img);
      card.appendChild(name);
      grid.appendChild(card);

      fetchImageBlobUrl(files[i]).then(url => { img.src = url; }).catch(() => {});
      card.onclick = () => openLightbox(i); // user gesture -> we can request fullscreen
    }
  }

  async function fetchImageBlobUrl(file) {
    if (file.blobUrl) return file.blobUrl;
    const imgRes = await fetch(`https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`, {
      headers: { Authorization: `Bearer ${accessToken}` }
    });
    if (!imgRes.ok) throw new Error('Fetch image failed: ' + (await imgRes.text()));
    const blob = await imgRes.blob();
    file.blobUrl = URL.createObjectURL(blob);
    return file.blobUrl;
  }

  // ====== Lightbox + Fullscreen ======
  document.getElementById('close').onclick = () => { box.classList.remove('open'); document.body.classList.remove('no-scroll'); tryExitFullscreen(); };
  document.getElementById('prev').onclick  = () => showIdx(idx - 1);
  document.getElementById('next').onclick  = () => showIdx(idx + 1);
  document.addEventListener('keydown', e => {
    if (!box.classList.contains('open')) return;
    if (e.key === 'Escape') { box.classList.remove('open'); document.body.classList.remove('no-scroll'); tryExitFullscreen(); }
    if (e.key === 'ArrowLeft')  showIdx(idx - 1);
    if (e.key === 'ArrowRight') showIdx(idx + 1);
  });

  function openLightbox(i) {
    idx = i;
    showIdx(idx);
    document.body.classList.add('no-scroll');
    box.classList.add('open');
    tryEnterFullscreen(box); // request fullscreen on user click
  }

  async function showIdx(i) {
    if (!files.length) return;
    if (i < 0) i = files.length - 1;
    if (i >= files.length) i = 0;
    idx = i;
    big.src = '';
    try { big.src = await fetchImageBlobUrl(files[idx]); } catch(e) { console.error(e); }
  }

  function tryEnterFullscreen(el) {
    const target = el || document.documentElement;
    const fn = target.requestFullscreen || target.webkitRequestFullscreen || target.msRequestFullscreen;
    if (fn) { try { fn.call(target); } catch(e){} }
  }

  function tryExitFullscreen() {
    const doc = document;
    const fn = doc.exitFullscreen || doc.webkitExitFullscreen || doc.msExitFullscreen;
    if (fn) { try { fn.call(doc); } catch(e){} }
  }

  function fail(err) {
    console.error(err);
    hintEl.textContent = 'Couldn’t load (no access or not signed in).';
    showSignIn();
  }
</script>
